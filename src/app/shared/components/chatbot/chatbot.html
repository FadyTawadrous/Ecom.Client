<button (click)="toggleChat()" class="chat-toggle-btn" [class.active]="opened">
  <mat-icon>{{ opened ? 'close' : 'smart_toy' }}</mat-icon>
</button>

@if (opened) {
<div class="chat-window">

  <div class="chat-header">
    <div class="header-title">
      <mat-icon class="header-icon">smart_toy</mat-icon>
      <span>AI Assistant</span>
    </div>
  </div>

  <div class="chat-body">

    @if (tableHtml) {
    <div class="html-content" [innerHTML]="tableHtml"></div>
    }

    @if (cleanAnswer) {
    <div class="message-bubble ai-message">
      {{ cleanAnswer }}
    </div>
    }

    @if (result?.products?.length) {
    <div class="products-table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Brand</th>
            <th>Category</th>
            <th class="text-right">Price</th>
          </tr>
        </thead>
        <tbody>
          @for (p of result.products; track p) {
          <tr>
            <td class="font-medium">{{ p.title }}</td>
            <td>{{ p.brandName }}</td>
            <td>{{ p.categoryName }}</td>
            <td class="text-right price">
              {{ p.price ? ('$' + p.price) : 'N/A' }}
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }

    @if (loading) {
    <div class="loading-state">
      <mat-spinner diameter="24"></mat-spinner>
      <span>Thinking...</span>
    </div>
    }

    @if (!loading && !cleanAnswer && !tableHtml && !result?.products?.length) {
    <div class="welcome-state">
      <p>How can I help you explore our collection today?</p>
    </div>
    }
  </div>

  <div class="chat-footer">
    <input [(ngModel)]="message" placeholder="Ask about products..." class="chat-input" (keydown.enter)="send()">

    <button mat-icon-button class="send-btn" (click)="send()" [disabled]="!message">
      <mat-icon>arrow_upward</mat-icon>
    </button>
  </div>

</div>
}